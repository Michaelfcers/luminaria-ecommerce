--Este es un txt que contiene todas las tablas usadas para crear la base de datos en supabase, usalas como contexto


-- Profiles
create table public.profiles (
  id uuid primary key references auth.users(id) on delete cascade,
  display_name text,
  role text check (role in ('buyer','seller','admin')) default 'buyer',
  phone_whatsapp text,
  avatar_url text,
  notification_prefs jsonb default '{}'::jsonb,
  created_at timestamptz default now(),
  deleted_at timestamptz
);

-- Stores
create table public.stores (
  id uuid primary key default gen_random_uuid(),
  owner_id uuid references public.profiles(id),
  name text not null,
  slug text unique,
  status text check (status in ('active','paused')) default 'active',
  whatsapp text,
  meta jsonb default '{}',
  created_at timestamptz default now(),
  deleted_at timestamptz
);

create table public.store_members (
  store_id uuid references public.stores(id) on delete cascade,
  user_id uuid references public.profiles(id) on delete cascade,
  role text check (role in ('owner','manager','staff')) default 'staff',
  created_at timestamptz default now(),
  primary key (store_id, user_id)
);

-- Catálogo
create table public.brands (
  id bigserial primary key,
  name text unique not null,
  slug text unique,
  created_at timestamptz default now(),
  deleted_at timestamptz
);

create table public.categories (
  id bigserial primary key,
  name text not null,
  slug text unique,
  parent_id bigint references public.categories(id),
  created_at timestamptz default now(),
  deleted_at timestamptz
);

create table public.products (
  id uuid primary key default gen_random_uuid(),
  store_id uuid references public.stores(id) on delete cascade,
  code text,                     -- CODIGO del PDF
  name text not null,
  description text,
  brand_id bigint references public.brands(id),
  status text check (status in ('draft','active','inactive')) default 'draft',
  sourcing_status text check (sourcing_status in ('active','backorder','discontinued')),
  life_hours int,
  lumens int,
  pieces_per_box int,
  list_price_usd numeric(12,2),
  currency text default 'USD',
  stock int default 0,
  attributes jsonb default '{}'::jsonb,
  created_at timestamptz default now(),
  updated_at timestamptz default now(),
  deleted_at timestamptz,
  search_tsv tsvector generated always as (
    setweight(to_tsvector('simple', coalesce(name,'')), 'A') ||
    setweight(to_tsvector('simple', coalesce(description,'')), 'B') ||
    to_tsvector('simple', coalesce(code,'')) ||
    to_tsvector('simple', coalesce(attributes::text,''))
  ) stored
);

create index on public.products using gin (search_tsv);
create index on public.products (brand_id) where deleted_at is null;

create table public.product_categories (
  product_id uuid references public.products(id) on delete cascade,
  category_id bigint references public.categories(id),
  primary key (product_id, category_id)
);

create table public.product_media (
  id bigserial primary key,
  product_id uuid references public.products(id) on delete cascade,
  type text check (type in ('image','pdf')) not null,
  url text not null,
  alt_text text,
  is_primary boolean default false,
  sort_order int default 0,
  created_at timestamptz default now(),
  deleted_at timestamptz
);

-- Promos
create table public.promotions (
  id uuid primary key default gen_random_uuid(),
  store_id uuid references public.stores(id) on delete cascade,
  name text not null,
  type text check (type in ('percentage','amount','bundle')) not null,
  value numeric(12,2),
  starts_at timestamptz,
  ends_at timestamptz,
  status text check (status in ('scheduled','active','expired')) default 'scheduled',
  conditions jsonb default '{}'::jsonb,
  usage_limit int,
  per_user_limit int,
  created_at timestamptz default now(),
  deleted_at timestamptz
);

create table public.promotion_products (
  promotion_id uuid references public.promotions(id) on delete cascade,
  product_id uuid references public.products(id) on delete cascade,
  primary key (promotion_id, product_id)
);

-- Carrito y órdenes
create table public.sessions (
  id uuid primary key default gen_random_uuid(),
  created_at timestamptz default now(),
  expires_at timestamptz
);

create table public.carts (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references public.profiles(id),
  session_id uuid references public.sessions(id),
  store_id uuid references public.stores(id),
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table public.cart_items (
  id bigserial primary key,
  cart_id uuid references public.carts(id) on delete cascade,
  product_id uuid references public.products(id),
  variant_id uuid,
  quantity int not null check (quantity > 0),
  price_at_add numeric(12,2),
  created_at timestamptz default now()
);

create table public.orders (
  id uuid primary key default gen_random_uuid(),
  code text unique,
  store_id uuid references public.stores(id),
  user_id uuid references public.profiles(id),
  guest_name text,
  guest_email text,
  guest_phone text,
  status text check (status in ('pending','confirmed','processing','ready_to_ship','shipped','completed','cancelled')) default 'pending',
  subtotal numeric(12,2) default 0,
  discount_total numeric(12,2) default 0,
  shipping_total numeric(12,2) default 0,
  total numeric(12,2) default 0,
  currency text default 'USD',
  notes text,
  created_at timestamptz default now(),
  updated_at timestamptz default now(),
  deleted_at timestamptz
);

create table public.order_items (
  id bigserial primary key,
  order_id uuid references public.orders(id) on delete cascade,
  product_id uuid references public.products(id),
  variant_id uuid,
  name_snapshot text,
  sku_snapshot text,
  unit_price numeric(12,2),
  quantity int not null check (quantity > 0),
  discount numeric(12,2) default 0,
  product_snapshot jsonb default '{}'::jsonb
);

create table public.order_status_history (
  id bigserial primary key,
  order_id uuid references public.orders(id) on delete cascade,
  status text not null,
  changed_by uuid references public.profiles(id),
  note text,
  created_at timestamptz default now()
);

-- Notificaciones
create table public.notification_endpoints (
  id uuid primary key default gen_random_uuid(),
  store_id uuid references public.stores(id) on delete cascade,
  channel text check (channel in ('whatsapp','email','webhook')) not null,
  config jsonb not null,
  enabled boolean default true
);

create table public.notifications (
  id bigserial primary key,
  order_id uuid references public.orders(id),
  store_id uuid references public.stores(id),
  recipient_user_id uuid references public.profiles(id),
  channel text check (channel in ('whatsapp','email','webhook')) not null,
  payload jsonb not null,
  status text check (status in ('pending','sent','failed')) default 'pending',
  error text,
  sent_at timestamptz,
  created_at timestamptz default now()
);
